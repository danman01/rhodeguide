<%#marker_code = ""
Location.all.each.collect {|loc| marker_code += "&markers=#{loc.latitude}%2C#{loc.longitude}" unless loc.latitude.blank?}
#%>
<%#= image_tag "http://maps.google.com/maps/api/staticmap?size=450x300&sensor=true&zoom=14#{marker_code}" %>
<script type="text/javascript" charset="utf-8">
  var marker_array = new Array();
  var marker_title_array = new Array();
  var marker_price_array = new Array();
  var marker_link_array = new Array();
  

  <%count = 0%>
  <%Location.all.each do |loc|%>
    <%next if loc.latitude.blank?%>
    <%count+=1%>
    var marker_<%=count%> = new google.maps.LatLng(<%=loc.latitude%>,<%=loc.longitude%>);
    marker_array.push(marker_<%=count%>)
    marker_title_array.push("<%=loc.address%>")
    marker_price_array.push("<%=loc.price%>")
    marker_link_array.push("<a href='/locations/<%=loc.id%>/' target='_blank'>View</a>")
    
  <%end%>
  var marker;
  var map;

// Drop animation
  function drop() {
    for (var i =0; i < marker_array.length; i++) {
      setTimeout(function() {
        addMarkerMethod();
      }, i * 50);
    }
  }

  // Toggle bounce
  function toggleBounce() {

    if (marker.getAnimation() != null) {
      marker.setAnimation(null);
    } else {
      marker.setAnimation(google.maps.Animation.BOUNCE);
    }
  }

function initialize() {
  var mapOptions = {
    zoom: 13,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    center: marker_array[1]
  };

  map = new google.maps.Map(document.getElementById('map-canvas'),
          mapOptions);
  for (var i = 0; i < marker_array.length; i++) {
    // set up content bubble
    var contentString = '<div id="content">'+
      '<div id="siteNotice">'+marker_title_array[i]+'</div>'+
      '<h1 id="firstHeading" class="firstHeading">Price</h1>'+marker_price_array[i]+
      '<div id="bodyContent">'+
      '<p><b>Link</b>'+marker_link_array[i]+
      '</div>'+
      '</div>';
    var infowindow = new google.maps.InfoWindow({
      content: contentString
    });
    marker = new google.maps.Marker({
      map:map,
      draggable:true,
      animation: google.maps.Animation.DROP,
      position: marker_array[i],
      title: marker_title_array[i]
    });
    add_click_event(marker,infowindow)
  };
}
function add_click_event(marker,infowindow){
  google.maps.event.addListener(marker, 'click', function() {
      infowindow.open(map,marker);
    });
}
google.maps.event.addDomListener(window, 'load', initialize);

</script>

<div id="map-canvas">
</div>
<%= form_tag locations_path, :method => :get do %>
  <p>
    <%= text_field_tag :search, params[:search] %>
    <%= submit_tag "Search Near", :name => nil %>
  </p>
<% end %>
<table>
  <tr>
    <th>Address</th>
    <th>Latitude</th>
    <th>Longitude</th>
    <th>Neighborhood</th>
    
    <th>Beds</th>
    <th>Bath</th>
    <th>Price</th>
    <th>Taxes</th>
    <th>Realtor Name</th>
    <th>Phone</th>
    <th>Link</th>
    <th>Notes</th>
    
  </tr>
  <% for location in @locations %>
    <tr>
      <td><%= location.address %></td>
      <td><%= location.latitude %></td>
      <td><%= location.longitude %></td>
      <td><%= location.neighborhood %></td>
      
      <td><%= location.beds %></td>
      <td><%= location.baths %></td>
      <td><%= location.price %></td>
      <td><%= location.taxes %></td>
      <td><%= location.name %></td>
      <td><%= location.phone %></td>
      <td><%= link_to location.link if !location.link.blank?%></td>
      <td><%= location.notes %></td>
      
      <td><%= link_to "Show", location %></td>
      <td><%= link_to "Edit", edit_location_path(location) %></td>
      <td><%= link_to "Destroy", location, :confirm => 'Are you sure?', :method => :delete %></td>
    </tr>
  <% end %>
</table>

<p><%= link_to "New Location", new_location_path %></p>
